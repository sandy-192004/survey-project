<!DOCTYPE html>
<html lang="en">
<%- include('partials/head') %>
<body class="d-flex flex-column min-vh-100">

<%- include('partials/navbar') %>

<div class="container-fluid px-3 px-md-4 py-4" style="flex: 1; background-color: var(--gray-50);">
  
  <!-- Page Header -->
  <div class="mb-4">
    <h1 class="h3 fw-bold mb-0"><i class="bi bi-people-fill text-primary me-2"></i>My Family</h1>
  </div>
  <% members = members || []; %>

  <% if (!members.length) { %>
    <div class="card border-0 shadow-sm">
      <div class="card-body text-center py-5">
        <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
        <h4 class="fw-bold mb-3">No Family Data Found</h4>
        <p class="text-muted mb-4">Start by adding your family details</p>
        <a href="/family-form" class="btn btn-primary">
          <i class="bi bi-plus-lg me-2"></i>Add Family Details
        </a>
      </div>
    </div>
  <% } %>

  <% // Get parents' address for children display %>
  <%
    let parentsAddress = {};
    const parents = members.filter(m => m.member_type === 'parent');
    if (parents.length > 0) {
      const parent = parents[0]; // Use first parent
      parentsAddress = {
        door_no: parent.door_no || '',
        street: parent.street || '',
        district: parent.district || '',
        state: parent.state || '',
        pincode: parent.pincode || ''
      };
    }
  %>

  <!-- Parents Section -->
  <% if (parents.length > 0) { %>
    <div class="mb-4">
      <h5 class="fw-bold mb-3 text-dark">
        <i class="bi bi-person-hearts text-primary me-2"></i>Parents
      </h5>
      <div class="row g-3">
        <% members.forEach(member => { %>
          <% if (member.member_type === 'parent') { %>
            <div class="col-12 col-md-6">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-3 position-relative">
                  
                  <!-- Edit Button -->
                  <button type="button" class="position-absolute top-0 end-0 m-2 btn btn-sm btn-light border-0 rounded-circle" 
                          onclick="openEditModal('<%= member.relationship %>', '<%= member.id %>')" 
                          style="width: 36px; height: 36px;">
                    <i class="bi bi-pencil-square text-primary"></i>
                  </button>
                  
                  <div class="row g-3">
                    <!-- Photo -->
                    <div class="col-auto">
                      <% if (member.photo && member.photo.trim() !== "") { %>
                        <% let photoSrc = member.photo; %>
                        <% const sizeMatch = photoSrc.match(/^(.+)\(\d+\)$/); %>
                        <% if (sizeMatch) photoSrc = sizeMatch[1]; %>
                        <% if (photoSrc.startsWith('/')) photoSrc = photoSrc.substring(1); %>
                        <% if (!photoSrc.startsWith('uploads/')) photoSrc = 'uploads/' + photoSrc; %>
                        <img src="/<%= photoSrc %>" class="rounded" style="width: 120px; height: 160px; object-fit: cover;" alt="<%= member.name %>">
                      <% } else { %>
                        <div class="rounded bg-light d-flex align-items-center justify-content-center" style="width: 120px; height: 160px;">
                          <i class="bi bi-person-fill text-muted" style="font-size: 3rem;"></i>
                        </div>
                      <% } %>
                    </div>
                    
                    <!-- Info -->
                    <div class="col">
                      <h5 class="fw-bold mb-2"><%= member.name %></h5>
                      <div class="text-muted small mb-1">
                        <i class="bi bi-heart-fill text-danger me-1"></i>
                        <span class="text-capitalize"><%= member.relationship %></span>
                      </div>
                      <div class="text-muted small mb-1">
                        <i class="bi bi-telephone-fill me-1"></i><%= member.mobile || 'N/A' %>
                      </div>
                      <div class="text-muted small mb-1">
                        <i class="bi bi-briefcase-fill me-1"></i><%= member.occupation || 'N/A' %>
                      </div>
                      <div class="text-muted small mb-1">
                        <i class="bi bi-gender-ambiguous me-1"></i>
                        <%
                          let gender = member.gender;
                          if (!gender || gender === '-') {
                            if (member.relationship === 'husband') gender = 'Male';
                            else if (member.relationship === 'wife') gender = 'Female';
                            else gender = 'N/A';
                          }
                        %>
                        <%= gender %>
                      </div>
                      <div class="text-muted small">
                        <i class="bi bi-geo-alt-fill me-1"></i>
                        <%= [member.door_no, member.street, member.district, member.state, member.pincode].filter(Boolean).join(', ') || 'N/A' %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% } %>
        <% }) %>
      </div>
    </div>
  <% } %>

  <!-- Children Section -->
  <div class="mb-4">
    <h5 class="fw-bold mb-3 text-dark">
      <i class="bi bi-person text-success me-2"></i>Children
    </h5>
    <div class="row g-3">
      <%
        const children = members.filter(m => m.member_type === 'child');
        if (children.length > 0) {
          children.forEach(member => {
      %>
        <div class="col-12 col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-3 position-relative">
              
              <!-- Edit Button -->
              <button type="button" class="position-absolute top-0 end-0 m-2 btn btn-sm btn-light border-0 rounded-circle" 
                      onclick="openEditModal('child', '<%= member.id %>')" 
                      style="width: 36px; height: 36px;">
                <i class="bi bi-pencil-square text-primary"></i>
              </button>
              
              <div class="row g-3">
                <!-- Photo -->
                <div class="col-auto">
                  <% if (member.photo && member.photo.trim() !== "") { %>
                    <% let photoSrc = member.photo; %>
                    <% const sizeMatch = photoSrc.match(/^(.+)\(\d+\)$/); %>
                    <% if (sizeMatch) photoSrc = sizeMatch[1]; %>
                    <% if (photoSrc.startsWith('/')) photoSrc = photoSrc.substring(1); %>
                    <% if (!photoSrc.startsWith('uploads/')) photoSrc = 'uploads/' + photoSrc; %>
                    <img src="/<%= photoSrc %>" class="rounded" style="width: 120px; height: 160px; object-fit: cover;" alt="<%= member.name %>">
                  <% } else { %>
                    <div class="rounded bg-light d-flex align-items-center justify-content-center" style="width: 120px; height: 160px;">
                      <i class="bi bi-person-fill text-muted" style="font-size: 3rem;"></i>
                    </div>
                  <% } %>
                </div>
                
                <!-- Info -->
                <div class="col">
                  <h5 class="fw-bold mb-2"><%= member.name %></h5>
                  <div class="text-muted small mb-1">
                    <i class="bi bi-heart-fill text-success me-1"></i>
                    <span class="text-capitalize"><%= member.relationship || 'Child' %></span>
                  </div>
                  <div class="text-muted small mb-1">
                    <i class="bi bi-briefcase-fill me-1"></i><%= member.occupation || 'N/A' %>
                  </div>
                  <div class="text-muted small mb-1">
                    <i class="bi bi-gender-ambiguous me-1"></i>
                    <%
                      let gender = member.gender;
                      if (!gender || gender === '-') {
                        if (member.relationship === 'son') gender = 'Male';
                        else if (member.relationship === 'daughter') gender = 'Female';
                        else gender = 'N/A';
                      }
                    %>
                    <%= gender %>
                  </div>
                  <div class="text-muted small">
                    <i class="bi bi-geo-alt-fill me-1"></i>
                    <%= [parentsAddress.door_no, parentsAddress.street, parentsAddress.district, parentsAddress.state, parentsAddress.pincode].filter(Boolean).join(', ') || 'N/A' %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      <%
          });
        }
      %>
    </div>
    
    <!-- Add Child Button -->
    <div class="mt-3">
      <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#addChildModal">
        <i class="bi bi-plus-lg me-2"></i>Add Child
      </button>
    </div>
  </div>

</div>

<!-- EDIT MODALS -->

  <!-- HUSBAND EDIT MODAL -->
  <div class="modal fade" id="husbandEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background:#6c757d;color:white;">
          <h5 class="modal-title">Edit Husband</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="husbandEditForm" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="name" placeholder="Husband Name" required>
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="mobile" placeholder="Mobile">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="occupation" placeholder="Occupation">
              </div>
              <div class="col-md-6">
                <input type="file" id="husband_photo_file" class="form-control mb-2 d-none" name="photo" accept="image/*" onchange="handleHusbandPhotoSelect(this)">
                <div id="husband_photo_placeholder" class="d-flex align-items-center justify-content-center position-relative" style="height: 100px; background-color: #f8f9fa; border: 1px dashed #dee2e6; cursor: pointer;" onclick="showPhotoOptions('husband_photo')">
                  <span class="text-muted">Click to upload or capture photo</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <img id="husbandPhotoPreview" src="" class="img-fluid mb-2" style="max-height: 200px; display: none;">
              </div>
            </div>
            <!-- Address Section -->
            <h6 class="mt-3 mb-2">Address</h6>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="husbandSameAsParents">
              <label class="form-check-label" for="husbandSameAsParents">
                Same as Parents Address
              </label>
            </div>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="door_no" placeholder="Door No">
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="street" placeholder="Street">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <input class="form-control mb-2" name="pincode" placeholder="Pincode" pattern="[0-9]{6}" title="Enter 6-digit pincode">
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="state" id="husbandState">
                  <option value="">Select State</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="district" id="husbandDistrict">
                  <option value="">Select District</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- WIFE EDIT MODAL -->
  <div class="modal fade" id="wifeEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background:#6c757d;color:white;">
          <h5 class="modal-title">Edit Wife</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="wifeEditForm" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="name" placeholder="Wife Name" required>
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="mobile" placeholder="Mobile">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="occupation" placeholder="Occupation">
              </div>
              <div class="col-md-6">
                <input type="file" id="wife_photo_file" class="form-control mb-2 d-none" name="photo" accept="image/*" onchange="handleWifePhotoSelect(this)">
                <div id="wife_photo_placeholder" class="d-flex align-items-center justify-content-center position-relative" style="height: 100px; background-color: #f8f9fa; border: 1px dashed #dee2e6; cursor: pointer;" onclick="showPhotoOptions('wife_photo')">
                  <span class="text-muted">Click to upload or capture photo</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <img id="wifePhotoPreview" src="" class="img-fluid mb-2" style="max-height: 200px; display: none;">
              </div>
            </div>
            <!-- Address Section -->
            <h6 class="mt-3 mb-2">Address</h6>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="wifeSameAsParents">
              <label class="form-check-label" for="wifeSameAsParents">
                Same as Parents Address
              </label>
            </div>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="door_no" placeholder="Door No">
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="street" placeholder="Street">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <input class="form-control mb-2" name="pincode" placeholder="Pincode" pattern="[0-9]{6}" title="Enter 6-digit pincode">
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="state" id="wifeState">
                  <option value="">Select State</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="district" id="wifeDistrict">
                  <option value="">Select District</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- CHILD EDIT MODAL -->
  <div class="modal fade" id="childEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background:#6c757d;color:white;">
          <h5 class="modal-title">Edit Child</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="childEditForm" enctype="multipart/form-data">
          <input type="hidden" name="member_id" value="">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="name" placeholder="Child Name" required>
              </div>
              <div class="col-md-6">
                <input type="date" class="form-control mb-2" name="dob">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <select class="form-control mb-2" name="gender">
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="occupation" placeholder="Occupation">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <select class="form-control mb-2" name="relationship">
                  <option value="">Relationship</option>
                  <option value="son">Son</option>
                  <option value="daughter">Daughter</option>
                </select>
              </div>
              <div class="col-md-6">
                <input type="file" id="child_photo_file" class="form-control mb-2 d-none" name="photo" accept="image/*" onchange="handleChildPhotoSelectEdit(this)">
                <div id="child_photo_placeholder" class="d-flex align-items-center justify-content-center position-relative" style="height: 100px; background-color: #f8f9fa; border: 1px dashed #dee2e6; cursor: pointer;" onclick="showPhotoOptions('child_photo')">
                  <span class="text-muted">Click to upload or capture photo</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <img id="childPhotoPreview" src="" class="img-fluid mb-2" style="max-height: 200px; display: none;">
              </div>
            </div>
            <!-- Address Section -->
            <h6 class="mt-3 mb-2">Address</h6>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="childSameAsParents">
              <label class="form-check-label" for="childSameAsParents">
                Same as Parents Address
              </label>
            </div>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="door_no" placeholder="Door No">
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="street" placeholder="Street">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <input class="form-control mb-2" name="pincode" placeholder="Pincode" pattern="[0-9]{6}" title="Enter 6-digit pincode">
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="state" id="editChildState">
                  <option value="">Select State</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="district" id="editChildDistrict">
                  <option value="">Select District</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ADD CHILD MODAL -->
  <div class="modal fade" id="addChildModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header" style="background:#6c757d;color:white;">
          <h5 class="modal-title">Add Child</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form id="addChildForm" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="name" placeholder="Child Name" required>
              </div>
              <div class="col-md-6">
                <input type="date" class="form-control mb-2" name="dob">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <select class="form-control mb-2" name="gender">
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="occupation" placeholder="Occupation">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <select class="form-control mb-2" name="relationship">
                  <option value="">Relationship</option>
                  <option value="son">Son</option>
                  <option value="daughter">Daughter</option>
                </select>
              </div>
              <div class="col-md-6">
                <input type="file" id="add_child_photo_file" class="form-control mb-2 d-none" name="photo" accept="image/*" onchange="handleAddChildPhotoSelect(this)">
                <div id="add_child_photo_placeholder" class="d-flex align-items-center justify-content-center position-relative" style="height: 100px; background-color: #f8f9fa; border: 1px dashed #dee2e6; cursor: pointer;" onclick="showPhotoOptions('add_child_photo')">
                  <span class="text-muted">Click to upload or capture photo</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <img id="addChildPhotoPreview" src="" class="img-fluid mb-2" style="max-height: 200px; display: none;">
              </div>
            </div>

            <!-- Address Section -->
            <h6 class="mt-3 mb-2">Address</h6>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="addChildSameAsParents">
              <label class="form-check-label" for="addChildSameAsParents">
                Same as Parents Address
              </label>
            </div>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="door_no" placeholder="Door No">
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="street" placeholder="Street">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <input class="form-control mb-2" name="pincode" placeholder="Pincode" pattern="[0-9]{6}" title="Enter 6-digit pincode">
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="state" id="childState">
                  <option value="">Select State</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="district" id="childDistrict">
                  <option value="">Select District</option>
                </select>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <%- include('partials/footer') %>
  
  <!-- SweetAlert2 - Required by family.js -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <%- include('partials/scripts') %>
  <script src="/js/family.js"></script>

  <script>
    let parentsAddress = {};

    // Load parents' address on page load
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const parentsRes = await fetch('/my-family-json');
        const familyData = await parentsRes.json();
        if (familyData.success && familyData.members) {
          const parents = familyData.members.filter(m => m.member_type === 'parent');
          if (parents.length > 0) {
            const parent = parents[0];
            parentsAddress = {
              door_no: parent.door_no || '',
              street: parent.street || '',
              state: parent.state || '',
              district: parent.district || '',
              pincode: parent.pincode || ''
            };
          }
        }
      } catch (err) {
        console.error("Error loading parents' address:", err);
      }
    });

    // Function to populate address fields from parents address
    async function populateAddressFields(modalId, isChecked) {
      const addressFields = ['door_no', 'street', 'pincode'];
      
      // First populate simple fields
      addressFields.forEach(field => {
        const element = document.querySelector(`#${modalId} [name="${field}"]`);
        if (element) {
          if (isChecked) {
            element.value = parentsAddress[field] || '';
          } else {
            element.value = '';
          }
        }
      });
      
      // Handle state and district specially
      const stateElement = document.querySelector(`#${modalId} [name="state"]`);
      const districtElement = document.querySelector(`#${modalId} [name="district"]`);
      
      if (stateElement && districtElement) {
        if (isChecked) {
          const parentState = parentsAddress.state || '';
          const parentDistrict = parentsAddress.district || '';
          
          // Set state first
          stateElement.value = parentState;
          
          // Load districts for the selected state
          if (parentState && indiaData[parentState]) {
            districtElement.innerHTML = '<option value="">Select District</option>';
            indiaData[parentState].forEach(district => {
              const option = document.createElement("option");
              option.value = district;
              option.textContent = district;
              districtElement.appendChild(option);
            });
            
            // Set district after a small delay to allow options to populate
            setTimeout(() => {
              districtElement.value = parentDistrict;
            }, 50);
          }
        } else {
          stateElement.value = '';
          districtElement.value = '';
        }
      }
    }

    // Handle checkbox for same as parents address in husband edit modal
    const husbandSameAsParentsCheckbox = document.getElementById('husbandSameAsParents');
    if (husbandSameAsParentsCheckbox) {
      husbandSameAsParentsCheckbox.addEventListener('change', function() {
        populateAddressFields('husbandEditModal', this.checked);
      });
    }

    // Handle checkbox for same as parents address in wife edit modal
    const wifeSameAsParentsCheckbox = document.getElementById('wifeSameAsParents');
    if (wifeSameAsParentsCheckbox) {
      wifeSameAsParentsCheckbox.addEventListener('change', function() {
        populateAddressFields('wifeEditModal', this.checked);
      });
    }

    // Handle checkbox for same as parents address in child edit modal
    const childSameAsParentsCheckbox = document.getElementById('childSameAsParents');
    if (childSameAsParentsCheckbox) {
      childSameAsParentsCheckbox.addEventListener('change', function() {
        populateAddressFields('childEditModal', this.checked);
      });
    }

    // Handle checkbox for same as parents address in add child modal
    const addChildSameAsParentsCheckbox = document.getElementById('addChildSameAsParents');
    if (addChildSameAsParentsCheckbox) {
      addChildSameAsParentsCheckbox.addEventListener('change', function() {
        populateAddressFields('addChildModal', this.checked);
      });
    }
  </script>

</body>
</html>