<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Family Member</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<% if (message) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert" style="background-color: #6c757d; color: white; border: none;">
    <%= message %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% } %>

<% if (!parent) { %>
  <div class="alert alert-danger">Parent record missing</div>
<% } else { %>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Edit Family</h4>
    <a href="/admin/dashboard" class="btn btn-danger btn-sm">X</a>
  </div>

  <form method="POST" action="/admin/edit/<%= familyId %>" enctype="multipart/form-data">
    <div class="row">
      <div class="col-md-6">
        <!-- Husband Details -->
        <div class="card mb-4">
          <div class="card-header"><h5>Husband Details</h5></div>
          <div class="card-body">
            <input class="form-control mb-2" name="name" value="<%= parent.husband_name %>" placeholder="Husband Name" required>
            <input class="form-control mb-2" name="mobile" value="<%= parent.mobile %>" placeholder="Mobile" required>
            <input class="form-control mb-2" name="occupation" value="<%= parent.occupation %>" placeholder="Occupation">
            <div class="mb-3">
              <label>Husband Photo</label>
              <input type="file" class="form-control" name="husband_photo" accept="image/*" id="husband_photo_input">
              <button type="button" class="btn btn-secondary mt-2" onclick="capturePhoto('husband_photo_input')">Capture Photo</button>
              <% if (parent.husband_photo) { %>
                <img src="/uploads/parents/<%= parent.husband_photo %>" class="img-thumbnail mt-2" style="max-width:100px;">
              <% } %>
            </div>
            <h6>Address</h6>
            <input class="form-control mb-2" name="door_no" value="<%= parent.door_no %>" placeholder="Door No">
            <input class="form-control mb-2" name="street" value="<%= parent.street %>" placeholder="Street">
            <input class="form-control mb-2" name="district" value="<%= parent.district %>" placeholder="District">
            <input class="form-control mb-2" name="state" value="<%= parent.state %>" placeholder="State">
            <input class="form-control mb-2" name="pincode" value="<%= parent.pincode %>" placeholder="Pincode">
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <!-- Wife Details -->
        <% if (wife) { %>
        <div class="card mb-4">
          <div class="card-header"><h5>Wife Details</h5></div>
          <div class="card-body">
            <input class="form-control mb-2" name="wife_name" value="<%= wife.name %>" placeholder="Wife Name">
            <input class="form-control mb-2" name="wife_mobile" value="<%= wife.mobile %>" placeholder="Mobile">
            <input class="form-control mb-2" name="wife_occupation" value="<%= wife.occupation %>" placeholder="Occupation">
            <div class="mb-3">
              <label>Wife Photo</label>
              <input type="file" class="form-control" name="wife_photo" accept="image/*" id="wife_photo_input">
              <button type="button" class="btn btn-secondary mt-2" onclick="capturePhoto('wife_photo_input')">Capture Photo</button>
              <% if (wife.photo) { %>
                <img src="/uploads/parents/<%= wife.photo %>" class="img-thumbnail mt-2" style="max-width:100px;">
              <% } %>
            </div>
            <input class="form-control mb-2" name="wife_door_no" value="<%= wife.door_no %>" placeholder="Door No">
            <input class="form-control mb-2" name="wife_street" value="<%= wife.street %>" placeholder="Street">
            <input class="form-control mb-2" name="wife_district" value="<%= wife.district %>" placeholder="District">
            <input class="form-control mb-2" name="wife_state" value="<%= wife.state %>" placeholder="State">
            <input class="form-control mb-2" name="wife_pincode" value="<%= wife.pincode %>" placeholder="Pincode">
          </div>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Children -->
    <div class="card mb-4">
      <div class="card-header"><h5>Children</h5></div>
      <div class="card-body" id="children">
        <% if (children && children.length > 0) { %>
        <% children.forEach((c, i) => { %>
            <div class="border p-3 mb-3 child">
              <input type="hidden" name="children[<%= i %>][id]" value="<%= c.child_id %>">
              <input class="form-control mb-1" name="children[<%= i %>][name]" value="<%= c.child_name %>" placeholder="Child Name">
              <select class="form-control mb-1" name="children[<%= i %>][gender]">
                <option value="">Select Gender</option>
                <option value="Male" <%= c.gender === 'Male' ? 'selected' : '' %>>Male</option>
                <option value="Female" <%= c.gender === 'Female' ? 'selected' : '' %>>Female</option>
                <option value="Other" <%= c.gender === 'Other' ? 'selected' : '' %>>Other</option>
              </select>
              <input class="form-control mb-1" name="children[<%= i %>][occupation]" value="<%= c.occupation %>" placeholder="Occupation">
              <input type="date" class="form-control mb-1" name="children[<%= i %>][dob]" value="<%= c.date_of_birth ? new Date(c.date_of_birth).toISOString().split('T')[0] : '' %>">
              <div class="mb-1">
                <label>Photo</label>
                <input type="file" class="form-control" name="children[<%= i %>][photo]" accept="image/*" id="child_photo_<%= i %>">
                <button type="button" class="btn btn-secondary mt-2" onclick="capturePhoto('child_photo_<%= i %>')">Capture Photo</button>
                <% if (c.photo) { %>
                  <img src="/uploads/children/<%= c.photo %>" class="img-thumbnail mt-1" style="max-width:100px;">
                <% } %>
              </div>
              <button type="button" class="btn btn-sm btn-danger removeChild">Remove</button>
            </div>
          <% }) %>
        <% } else { %>
          <p>No children added yet.</p>
        <% } %>
      </div>
      <button type="button" class="btn btn-secondary my-2" id="addChild">+ Add Child</button>
    </div>

    <div class="mt-3">
      <button type="submit" class="btn btn-primary">Update Family</button>
      <a href="/admin/dashboard" class="btn btn-outline-secondary">Cancel</a>
    </div>
  </form>
</div>
<% } %>

<!-- Add Child Modal -->
<div class="modal fade" id="addChildModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Child</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="/admin/add-child" enctype="multipart/form-data">
          <input type="hidden" name="family_id" value="<%= familyId %>">
          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-label">Name</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label">Gender</label>
              <select class="form-control" name="gender" required>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control" name="dob" required>
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label">Occupation</label>
              <input class="form-control" name="occupation">
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label">Photo</label>
              <input type="file" class="form-control" name="photo" accept="image/*">
            </div>
          </div>
          <button class="btn btn-success">Add Child</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  let index =  (children && children.length) ? children.length : 0;

  $("#addChild").click(() => {
    $("#children").append(`
      <div class="border p-2 mb-2 child">
        <input class="form-control mb-1" name="children[${index}][name]" placeholder="Child Name">
        <select class="form-control mb-1" name="children[${index}][gender]">
          <option value="">Select Gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
        <input class="form-control mb-1" name="children[${index}][occupation]" placeholder="Occupation">
        <input type="date" class="form-control mb-1" name="children[${index}][dob]" placeholder="Date of Birth">
        <div class="mb-1">
          <label>Photo</label>
          <input type="file" class="form-control" name="children[${index}][photo]" accept="image/*" id="child_photo_${index}">
          <button type="button" class="btn btn-secondary mt-2" onclick="capturePhoto('child_photo_${index}')">Capture Photo</button>
        </div>
        <button type="button" class="btn btn-sm btn-danger removeChild">Remove</button>
      </div>
    `);
    index++;
  });

  $(document).on("click", ".removeChild", function () {
    $(this).closest(".child").remove();
  });

  function capturePhoto(inputId) {
    const input = document.getElementById(inputId);
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
          const video = document.createElement('video');
          video.srcObject = stream;
          video.play();

          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');

          // Create a modal or overlay to show the camera
          const modal = document.createElement('div');
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = '0';
          modal.style.width = '100%';
          modal.style.height = '100%';
          modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
          modal.style.display = 'flex';
          modal.style.flexDirection = 'column';
          modal.style.alignItems = 'center';
          modal.style.justifyContent = 'center';
          modal.style.zIndex = '1000';

          const videoContainer = document.createElement('div');
          videoContainer.appendChild(video);
          modal.appendChild(videoContainer);

          const captureButton = document.createElement('button');
          captureButton.textContent = 'Capture';
          captureButton.className = 'btn btn-primary mt-3';
          captureButton.onclick = function() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            canvas.toBlob(function(blob) {
              const file = new File([blob], 'captured_photo.jpg', { type: 'image/jpeg' });
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(file);
              input.files = dataTransfer.files;
              document.body.removeChild(modal);
              stream.getTracks().forEach(track => track.stop());
            });
          };
          modal.appendChild(captureButton);

          const cancelButton = document.createElement('button');
          cancelButton.textContent = 'Cancel';
          cancelButton.className = 'btn btn-secondary mt-2';
          cancelButton.onclick = function() {
            document.body.removeChild(modal);
            stream.getTracks().forEach(track => track.stop());
          };
          modal.appendChild(cancelButton);

          document.body.appendChild(modal);
        })
        .catch(function(err) {
          console.error('Error accessing camera: ', err);
          alert('Camera access denied or not available.');
        });
    } else {
      alert('Camera not supported on this device.');
    }
  }
</script>

</body>
</html>