<!DOCTYPE html>
<html lang="en">
<head>
  <title>My Family</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* ----- Brown-themed styling ----- */
    .family-header {
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
      text-align: center;
      border-radius: 10px;
    }

    .member-card {
      border: none;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      transition: transform 0.3s ease;
      margin-bottom: 1rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .member-card:hover { transform: translateY(-5px); }

    .member-photo {
      height: 200px;
      object-fit: cover;
      border-bottom: 3px solid #8B4513;
    }

    .member-info { padding: 1rem; }
    .member-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; color: #5C4033; }
    .info-item { margin-bottom: 0.4rem; display: flex; align-items: center; font-size: 0.9rem; color: #4B3621; }
    .info-item i { width: 18px; color: #8B4513; margin-right: 0.4rem; font-size: 0.9rem; }

    .edit-btn, .update-btn { margin: 0.25rem; border-radius: 20px; font-size: 0.85rem; }

    .no-data {
      text-align: center;
      padding: 2rem 1rem;
      color: #5C4033;
    }

    @media (max-width: 768px) {
      .container { padding: 1rem; margin-top: 1rem; }
      .member-photo { height: 150px; }
      .member-info { padding: 0.8rem; }
      .member-name { font-size: 1rem; }
      .info-item { font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="family-header">
      <h3>My Family</h3>
    </div>

    <% members = members || []; %>

    <% if (!members || members.length === 0) { %>
      <div class="no-data">
        <h4>No family members found</h4>
        <p>Please add your family information</p>
        <a href="/family-form" class="btn btn-primary">Add Family</a>
      </div>
    <% } %>

    <% if (members && members.length > 0) { %>
      <div class="row">
        <% members.forEach(member => { %>
          <div class="col-md-4 mb-4">
            <div class="card member-card shadow-sm">
              <% if (member.photo) { %>
                <img src="/uploads/<%= member.photo %>" class="card-img-top member-photo" alt="<%= member.name %>">
              <% } else { %>
                <div class="member-photo bg-light d-flex align-items-center justify-content-center">
                  <i class="fas fa-user fa-3x text-muted"></i>
                </div>
              <% } %>

              <div class="member-info">
                <h5 class="member-name"><%= member.name %></h5>
                <div class="info-item"><i class="fas fa-user-tag"></i><strong>Type:</strong>&nbsp;<%= member.member_type %></div>
                <div class="info-item"><i class="fas fa-link"></i><strong>Relationship:</strong>&nbsp;<%= member.relationship %></div>
                <% if (member.mobile) { %>
                  <div class="info-item"><i class="fas fa-phone"></i><strong>Mobile:</strong>&nbsp;<%= member.mobile %></div>
                <% } %>
                <% if (member.occupation) { %>
                  <div class="info-item"><i class="fas fa-briefcase"></i><strong>Occupation:</strong>&nbsp;<%= member.occupation %></div>
                <% } %>
                <% if (member.gender) { %>
                  <div class="info-item"><i class="fas fa-venus-mars"></i><strong>Gender:</strong>&nbsp;<%= member.gender %></div>
                <% } %>

                <div class="text-center mt-2">
                  <button class="btn btn-warning edit-btn" onclick="openEditModal(<%= member.id %>)">‚úèÔ∏è Edit</button>
                  <button class="btn btn-success update-btn" onclick="updateMember(<%= member.id %>)">üíæ Update</button>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="editForm" class="modal-content" enctype="multipart/form-data">
        <div class="modal-header bg-brown text-white" style="background-color:#A0522D;">
          <h5 class="modal-title">Edit Family Member</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editId" name="id">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" id="editName" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Mobile</label>
            <input type="text" id="editMobile" name="mobile" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Occupation</label>
            <input type="text" id="editOccupation" name="occupation" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Photo</label>
            <input type="file" id="editPhoto" name="photo" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function openEditModal(id) {
      fetch('/family/edit/' + id)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById('editId').value = data.member.id;
            document.getElementById('editName').value = data.member.name;
            document.getElementById('editMobile').value = data.member.mobile || '';
            document.getElementById('editOccupation').value = data.member.occupation || '';
            new bootstrap.Modal(document.getElementById('editModal')).show();
          } else {
            alert('Failed to load member details.');
          }
        })
        .catch(() => alert('Error fetching member info'));
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editId').value;
      const formData = new FormData(e.target);
      const res = await fetch('/family/update/' + id, {
        method: 'POST',
        body: formData
      });
      const result = await res.json();
      if (result.success) {
        alert('Member updated successfully!');
        location.reload();
      } else {
        alert('Update failed: ' + result.message);
      }
    });

    function updateMember(id) {
      alert('This button can later trigger a status or live update if needed.');
    }
  </script>
</body>
</html>
