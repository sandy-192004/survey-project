<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Family</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>

  body {
    margin: 0;
    background-color: #f5e6d3;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }

  .family-header {
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    background: linear-gradient(135deg, #8B4513, #A0522D);
    color: white;
    padding: 1.5rem 1rem;
    text-align: center;
    font-size: 2rem;
    font-weight: bold;
  }

  .section-title {
    margin: 1.5625rem 0 0.625rem;
    font-weight: bold;
    color: #5a3e2b;
  }

  .parents-row,
  .children-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
  }

  /* ==== THIS IS THE KEY MATCHING CARD STYLE ==== */
  .member-card {
    min-width: 18.75rem;
    max-width: 31.25rem;
    background-color: #f9f1e6;
    border-radius: 0.875rem;
    padding: 1.25rem;
    position: relative;
    box-shadow: 0 0.375rem 1.125rem rgba(0,0,0,0.15);
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .member-info {
    text-align: left;
    flex: 1;
  }

  .member-name {
    font-size: 2rem;
    font-weight: bold;
    color: #5a3e2b;
    margin-bottom: 0.1875rem;
  }

  .info-item {
    font-size: 1rem;
    color: #4b3621;
    margin-bottom: 0.25rem;
  }

  /* ==== MATCHED PHOTO SIZE ==== */
  .member-photo {
    width: 12rem;
    height: 16rem;
    object-fit: cover;
    border-radius: 0.75rem;
    border: 0.125rem solid #d1b89a;
    flex-shrink: 0;
  }

  /* Keep your edit icon but visually consistent */
  .edit-icon {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: #8B4513;
    color: white;
    padding: 0.375rem;
    border-radius: 50%;
    font-size: 0.75rem;
    cursor: pointer;
    border: none;
    min-width: 2.75rem;
    min-height: 2.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Keep Add Child bar but lighter look */
  .add-child-bar {
    margin: 1.25rem 0;
    background-color: #8B4513;
    color: white;
    text-align: center;
    padding: 0.625rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-weight: bold;
    min-height: 2.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (max-width: 768px) {
    body {
      font-size: 14px;
    }
    .parents-row,
    .children-row {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .member-card {
      min-width: 100%;
      padding: 0.75rem;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .member-info {
      text-align: left;
      flex: 1;
    }

    .member-name {
      font-size: 1.5rem;
    }

    .info-item {
      font-size: 0.9rem;
    }

    .member-photo {
      width: 9rem;
      height: 12rem;
    }

    .btn {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section-title {
      background-color: #f5efe9;
      padding: 8px 12px;
      border-radius: 5px;
      margin-bottom: 1rem;
    }

    .add-child-bar {
      background-color: #6f4e37;
      color: white;
    }
  }
</style>

  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="family-header">
    My Family
  </div>

  <div class="container mt-4">

    <% members = members || []; %>

    <% if (!members.length) { %>
      <div class="text-center mt-4 text-muted">
        <h4>No family data found</h4>
        <a href="/family-form" class="btn btn-primary mt-2">Add Family</a>
      </div>
    <% } %>

    <% // Get parents' address for children display %>
    <%
      let parentsAddress = {};
      const parents = members.filter(m => m.member_type === 'parent');
      if (parents.length > 0) {
        const parent = parents[0]; // Use first parent
        parentsAddress = {
          door_no: parent.door_no || '',
          street: parent.street || '',
          district: parent.district || '',
          state: parent.state || '',
          pincode: parent.pincode || ''
        };
      }
    %>

    <!-- ================= PARENTS ================= -->
    <h5 class="section-title" style="background-color: #f5e6d3; color: #8B4513;">Parents</h5>
    <div class="parents-row">

      <% members.forEach(member => { %>
        <% if (member.member_type === 'parent') { %>

          <div class="member-card">
            <% if (member.relationship === 'husband') { %>
              <button type="button" class="edit-icon" onclick="openEditModal('husband', '<%= member.id %>')"><i class="fas fa-edit"></i></button>
            <% } else if (member.relationship === 'wife') { %>
              <button type="button" class="edit-icon" onclick="openEditModal('wife', '<%= member.id %>')"><i class="fas fa-edit"></i></button>
            <% } %>

            <% if (member.photo && member.photo.trim() !== "") { %>
              <% let photoSrc = member.photo; %>
              <% // Remove size from photo path if present %>
              <% const sizeMatch = photoSrc.match(/^(.+)\(\d+\)$/); %>
              <% if (sizeMatch) photoSrc = sizeMatch[1]; %>
              <% if (photoSrc.startsWith('/')) photoSrc = photoSrc.substring(1); %>
              <% if (photoSrc.startsWith('uploads/')) { %>
                <img src="/<%= photoSrc %>" class="member-photo">
              <% } else { %>
                <img src="/uploads/<%= photoSrc %>" class="member-photo">
              <% } %>
            <% } else { %>
              <img src="https://via.placeholder.com/120x120?text=No+Photo" class="member-photo">
            <% } %>

            <div class="member-info">
              <div class="member-name"><%= member.name %></div>
              <div class="info-item"><b>Relationship:</b> <%= member.relationship %></div>
              <div class="info-item"><b>Mobile:</b> <%= member.mobile || '-' %></div>
              <div class="info-item"><b>Occupation:</b> <%= member.occupation || '-' %></div>
              <div class="info-item"><b>Gender:</b>
                <%
                  let gender = member.gender;
                  if (!gender || gender === '-') {
                    if (member.relationship === 'husband') gender = 'Male';
                    else if (member.relationship === 'wife') gender = 'Female';
                    else if (member.relationship === 'son') gender = 'Male';
                    else if (member.relationship === 'daughter') gender = 'Female';
                    else gender = '-';
                  }
                %>
                <%= gender %>
              </div>
              <div class="info-item"><b>Address:</b> <%= [member.door_no, member.street, member.district, member.state, member.pincode].filter(Boolean).join(', ') || '-' %></div>
            </div>
          </div>

        <% } %>
      <% }) %>

    </div>

    <!-- ================= CHILDREN ================= -->
    <h5 class="section-title" style="background-color: #f5e6d3; color: #8B4513;">Children</h5>
    <div class="children-row">

      <% members.forEach(member => { %>
        <% if (member.member_type === 'child') { %>

          <div class="member-card">
            <button type="button" class="edit-icon" onclick="openEditModal('child', '<%= member.id %>')"><i class="fas fa-edit"></i></button>

            <% if (member.photo && member.photo.trim() !== "") { %>
              <% let photoSrc = member.photo; %>
              <% // Remove size from photo path if present %>
              <% const sizeMatch = photoSrc.match(/^(.+)\(\d+\)$/); %>
              <% if (sizeMatch) photoSrc = sizeMatch[1]; %>
              <% if (photoSrc.startsWith('/')) photoSrc = photoSrc.substring(1); %>
              <% if (photoSrc.startsWith('uploads/')) { %>
                <img src="/<%= photoSrc %>" class="member-photo">
              <% } else { %>
                <img src="/uploads/<%= photoSrc %>" class="member-photo">
              <% } %>
            <% } else { %>
              <img src="https://via.placeholder.com/120x120?text=No+Photo" class="member-photo">
            <% } %>

            <div class="member-info">
              <div class="member-name"><%= member.name %></div>
              <div class="info-item"><b>Name:</b> <%= member.name %></div>
              <div class="info-item"><b>Relationship:</b> <%= member.relationship || '-' %></div>
              <div class="info-item"><b>Occupation:</b> <%= member.occupation || '-' %></div>
              <div class="info-item"><b>Gender:</b>
                <%
                  let gender = member.gender;
                  if (!gender || gender === '-') {
                    if (member.relationship === 'husband') gender = 'Male';
                    else if (member.relationship === 'wife') gender = 'Female';
                    else if (member.relationship === 'son') gender = 'Male';
                    else if (member.relationship === 'daughter') gender = 'Female';
                    else gender = '-';
                  }
                %>
                <%= gender %>
              </div>
              <div class="info-item"><b>Address:</b> <%= [parentsAddress.door_no, parentsAddress.street, parentsAddress.district, parentsAddress.state, parentsAddress.pincode].filter(Boolean).join(', ') || '-' %></div>
            </div>
          </div>

        <% } %>
      <% }) %>

    </div>

    <div class="add-child-bar" data-bs-toggle="modal" data-bs-target="#addChildModal">
      + Add Child
    </div>

  </div>

  <!-- EDIT MODALS -->

  <!-- HUSBAND EDIT MODAL -->
  <div class="modal fade" id="husbandEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background:#A0522D;color:white;">
          <h5 class="modal-title">Edit Husband</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="husbandEditForm" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="name" placeholder="Husband Name" required>
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="mobile" placeholder="Mobile">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="occupation" placeholder="Occupation">
              </div>
              <div class="col-md-6">
                <input type="file" class="form-control mb-2" name="photo" accept="image/*" id="husbandPhotoFile_file" style="display: none;" onchange="handlePhotoSelect(this, 'husbandPhotoFile')">
                <div id="husbandPhotoFile_placeholder" class="d-flex align-items-center justify-content-center position-relative" style="height: 100px; background-color: #f8f9fa; border: 1px dashed #dee2e6; cursor: pointer;" onclick="showPhotoOptions('husbandPhotoFile')">
                  <span class="text-muted">Click to upload or capture photo</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <img id="husbandPhotoPreview" src="" class="img-fluid mb-2" style="max-height: 200px; display: none;">
              </div>
            </div>
            <!-- Address Section -->
            <h6 class="mt-3 mb-2">Address</h6>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="door_no" placeholder="Door No">
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="street" placeholder="Street">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <input class="form-control mb-2" name="pincode" placeholder="Pincode" pattern="[0-9]{6}" title="Enter 6-digit pincode">
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="state" id="husbandState">
                  <option value="">Select State</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="district" id="husbandDistrict">
                  <option value="">Select District</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- WIFE EDIT MODAL -->
  <div class="modal fade" id="wifeEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background:#A0522D;color:white;">
          <h5 class="modal-title">Edit Wife</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="wifeEditForm" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="name" placeholder="Wife Name" required>
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="mobile" placeholder="Mobile">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="occupation" placeholder="Occupation">
              </div>
              <div class="col-md-6">
                <input type="file" class="form-control mb-2" name="photo" accept="image/*" id="wife_file" style="display: none;" onchange="handlePhotoSelect(this, 'wife')">
                <div id="wife_placeholder" class="d-flex align-items-center justify-content-center position-relative" style="height: 100px; background-color: #f8f9fa; border: 1px dashed #dee2e6; cursor: pointer;" onclick="showPhotoOptions('wife')">
                  <span class="text-muted">Click to upload or capture photo</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <img id="wifePhotoPreview" src="" class="img-fluid mb-2" style="max-height: 200px; display: none;">
              </div>
            </div>
            <!-- Address Section -->
            <h6 class="mt-3 mb-2">Address</h6>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="door_no" placeholder="Door No">
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="street" placeholder="Street">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <input class="form-control mb-2" name="pincode" placeholder="Pincode" pattern="[0-9]{6}" title="Enter 6-digit pincode">
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="state" id="wifeState">
                  <option value="">Select State</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="district" id="wifeDistrict">
                  <option value="">Select District</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- CHILD EDIT MODAL -->
  <div class="modal fade" id="childEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background:#A0522D;color:white;">
          <h5 class="modal-title">Edit Child</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="childEditForm" enctype="multipart/form-data">
          <input type="hidden" name="member_id" value="">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="name" placeholder="Child Name" required>
              </div>
              <div class="col-md-6">
                <input type="date" class="form-control mb-2" name="dob">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <select class="form-control mb-2" name="gender">
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="occupation" placeholder="Occupation">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <select class="form-control mb-2" name="relationship">
                  <option value="">Relationship</option>
                  <option value="son">Son</option>
                  <option value="daughter">Daughter</option>
                </select>
              </div>
              <div class="col-md-6">
                <input type="file" class="form-control mb-2" name="photo" accept="image/*" id="childPhotoFile" style="display: none;">
                <div id="childPhotoFile_placeholder" class="d-flex align-items-center justify-content-center position-relative" style="height: 100px; background-color: #f8f9fa; border: 1px dashed #dee2e6; cursor: pointer;" onclick="showPhotoOptions('childPhotoFile')">
                  <span class="text-muted">Click to upload or capture photo</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <img id="childPhotoPreview" src="" class="img-fluid mb-2" style="max-height: 200px; display: none;">
              </div>
            </div>
            <!-- Address Section -->
            <h6 class="mt-3 mb-2">Address</h6>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="childSameAsParents">
              <label class="form-check-label" for="childSameAsParents">Same as Parents' Address</label>
            </div>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="door_no" placeholder="Door No">
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="street" placeholder="Street">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <input class="form-control mb-2" name="pincode" placeholder="Pincode" pattern="[0-9]{6}" title="Enter 6-digit pincode">
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="state" id="editChildState">
                  <option value="">Select State</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="district" id="editChildDistrict">
                  <option value="">Select District</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ADD CHILD MODAL -->
  <div class="modal fade" id="addChildModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header" style="background:#A0522D;color:white;">
          <h5 class="modal-title">Add Child</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form id="addChildForm" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="name" placeholder="Child Name" required>
              </div>
              <div class="col-md-6">
                <input type="date" class="form-control mb-2" name="dob">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <select class="form-control mb-2" name="gender">
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="occupation" placeholder="Occupation">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <select class="form-control mb-2" name="relationship">
                  <option value="">Relationship</option>
                  <option value="son">Son</option>
                  <option value="daughter">Daughter</option>
                </select>
              </div>
              <div class="col-md-6">
                <input type="file" class="form-control mb-2" name="photo" accept="image/*">
              </div>
            </div>

            <!-- Address Section -->
            <h6 class="mt-3 mb-2">Address</h6>
            <div class="row">
              <div class="col-md-6">
                <input class="form-control mb-2" name="door_no" placeholder="Door No">
              </div>
              <div class="col-md-6">
                <input class="form-control mb-2" name="street" placeholder="Street">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <input class="form-control mb-2" name="pincode" placeholder="Pincode" pattern="[0-9]{6}" title="Enter 6-digit pincode">
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="state" id="childState">
                  <option value="">Select State</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-control mb-2" name="district" id="childDistrict">
                  <option value="">Select District</option>
                </select>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>

      </div>
    </div>
  </div>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/family.js"></script>

  <script>
    let parentsAddress = {};

    // Fade in on page load
    window.addEventListener('load', function() {
      document.body.style.opacity = '1';
    });

    // Load parents' address on page load
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const parentsRes = await fetch('/my-family-json');
        const familyData = await parentsRes.json();
        if (familyData.success && familyData.members) {
          const parents = familyData.members.filter(m => m.member_type === 'parent');
          if (parents.length > 0) {
            const parent = parents[0];
            parentsAddress = {
              door_no: parent.door_no || '',
              street: parent.street || '',
              state: parent.state || '',
              district: parent.district || '',
              pincode: parent.pincode || ''
            };
          }
        }
      } catch (err) {
        console.error("Error loading parents' address:", err);
      }
    });

    // Handle checkbox for same as parents address in child edit modal
    document.getElementById('childSameAsParents').addEventListener('change', function() {
      const isChecked = this.checked;
      const addressFields = ['door_no', 'street', 'state', 'district', 'pincode'];

      addressFields.forEach(field => {
        const element = document.querySelector(`#childEditModal [name="${field}"]`);
        if (isChecked) {
          element.value = parentsAddress[field] || '';
          element.disabled = true;
        } else {
          element.disabled = false;
        }
      });
    });
  </script>

</body>
</html>
