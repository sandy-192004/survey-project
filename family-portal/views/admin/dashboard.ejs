<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">

    <h3 class="mb-4">Admin Dashboard - Family Grid View</h3>

    <!-- Search & Filter -->
    <form action="/admin/search" method="GET" class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="row g-2 align-items-center">

                <!-- Search -->
                <div class="col-md-4">
                    <input type="text"
                           name="q"
                           class="form-control"
                           placeholder="Search family..."
                           value="<%= searchValue || '' %>">
                </div>

                <!-- State -->
                <div class="col-md-3">
                    <select name="state" class="form-select">
                        <option value="">State</option>
                        <% if (stateOptions && stateOptions.length) { %>
                            <% stateOptions.forEach(s => { %>
                                <option value="<%= s %>"
                                    <%= selectedState === s ? 'selected' : '' %>>
                                    <%= s %>
                                </option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>

                <!-- District -->
                <div class="col-md-3">
                    <select name="district" class="form-select">
                        <option value="">District</option>
                        <% if (districtOptions && districtOptions.length) { %>
                            <% districtOptions.forEach(d => { %>
                                <option value="<%= d %>"
                                    <%= selectedDistrict === d ? 'selected' : '' %>>
                                    <%= d %>
                                </option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>

                <!-- Filter Button -->
                <div class="col-md-2 d-grid">
                    <button class="btn btn-primary">Filter</button>
                </div>

            </div>
        </div>
    </form>

    <!-- Message -->
    <% if (message) { %>
        <div class="alert alert-info text-center mb-4"><%= message %></div>
    <% } %>

    <!-- Filter Summary -->
    <% if (selectedState || selectedDistrict || searchValue) { %>
        <div class="alert alert-secondary text-center mb-4">
            <strong>Filtered Results:</strong>
            <% if (searchValue) { %> Search: "<%= searchValue %>" <% } %>
            <% if (selectedState) { %> | State: <%= selectedState %> <% } %>
            <% if (selectedDistrict) { %> | District: <%= selectedDistrict %> <% } %>
            <a href="/admin/dashboard" class="btn btn-sm btn-outline-secondary ms-2">Clear Filters</a>
        </div>
    <% } %>

    <!-- Cards -->
    <div class="row g-4">
        <% if (results && results.length > 0) { %>
            <%
            let allMembers = [];
            results.forEach(member => {
                // Add husband
                allMembers.push({
                    name: member.husband_name,
                    relation: 'Husband',
                    occupation: member.occupation,
                    mobile: member.mobile,
                    email: member.email || 'N/A',
                    address: `${member.door_no}, ${member.street}, ${member.district}, ${member.state} - ${member.pincode}`,
                    photo: member.husband_photo,
                    familyId: member.id
                });
                // Add wife if exists
                if (member.wife_name) {
                    allMembers.push({
                        name: member.wife_name,
                        relation: 'Wife',
                        occupation: 'N/A',
                        mobile: member.mobile,
                        email: member.email || 'N/A',
                        address: `${member.door_no}, ${member.street}, ${member.district}, ${member.state} - ${member.pincode}`,
                        photo: member.wife_photo,
                        familyId: member.id
                    });
                }
                // Add children
                if (member.children_names) {
                    const childNames = member.children_names.split(', ');
                    const childDobs = member.children_dobs ? member.children_dobs.split(', ') : [];
                    const childOccupations = member.children_occupations ? member.children_occupations.split(', ') : [];
                    childNames.forEach((name, index) => {
                        allMembers.push({
                            name: name,
                            relation: 'Child',
                            occupation: childOccupations[index] || 'Student',
                            dob: childDobs[index],
                            gender: 'N/A',
                            photo: null,
                            familyId: member.id
                        });
                    });
                }
            });
            %>
            <% allMembers.forEach(member => { %>
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><%= member.relation %></h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Name:</strong> <%= member.name %></p>
                            <% if (member.occupation) { %>
                                <p><strong>Occupation:</strong> <%= member.occupation %></p>
                            <% } %>
                            <% if (member.mobile) { %>
                                <p><strong>Mobile:</strong> <%= member.mobile %></p>
                            <% } %>
                            <% if (member.email && member.email !== 'N/A') { %>
                                <p><strong>Email:</strong> <%= member.email %></p>
                            <% } %>
                            <% if (member.address) { %>
                                <p><strong>Address:</strong> <%= member.address %></p>
                            <% } %>
                            <% if (member.dob) { %>
                                <p><strong>Date of Birth:</strong> <%= new Date(member.dob).toDateString() %></p>
                            <% } %>
                            <% if (member.gender) { %>
                                <p><strong>Gender:</strong> <%= member.gender %></p>
                            <% } %>
                            <% if (member.photo) { %>
                                <img src="/<%= member.photo %>"
                                     class="rounded-circle mt-2"
                                     width="50" height="50">
                            <% } %>
                        </div>
                        <div class="card-footer bg-white border-0">
                            <a href="/admin/view/<%= member.familyId %>" class="btn btn-sm btn-info text-white">
                                View Family
                            </a>
                        </div>
                    </div>
                </div>
            <% }) %>
        <% } %>
    </div>

    <!-- Pagination -->
    <% if (totalPages && totalPages > 1) { %>
        <nav class="mt-4">
            <ul class="pagination justify-content-center">

                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                    <a class="page-link"
                       href="?q=<%= encodeURIComponent(searchValue || '') %>&state=<%= encodeURIComponent(selectedState || '') %>&district=<%= encodeURIComponent(selectedDistrict || '') %>&page=<%= currentPage - 1 %>">
                        &laquo;
                    </a>
                </li>

                <% for (let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                        <a class="page-link"
                           href="?q=<%= encodeURIComponent(searchValue || '') %>&state=<%= encodeURIComponent(selectedState || '') %>&district=<%= encodeURIComponent(selectedDistrict || '') %>&page=<%= i %>">
                            <%= i %>
                        </a>
                    </li>
                <% } %>

                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                    <a class="page-link"
                       href="?q=<%= encodeURIComponent(searchValue || '') %>&state=<%= encodeURIComponent(selectedState || '') %>&district=<%= encodeURIComponent(selectedDistrict || '') %>&page=<%= currentPage + 1 %>">
                        &raquo;
                    </a>
                </li>

            </ul>
        </nav>
    <% } %>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- State â†’ District JS -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const stateSelect = document.querySelector('select[name="state"]');
    const districtSelect = document.querySelector('select[name="district"]');

    const stateDistrictMap = stateDistrictMap || {}

    stateSelect.addEventListener('change', function () {
        const selectedState = this.value;
        districtSelect.innerHTML = '<option value="">District</option>';

        if (selectedState && stateDistrictMap[selectedState]) {
            stateDistrictMap[selectedState].forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
    });
});
</script>

</body>
</html>
