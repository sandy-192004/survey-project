<!DOCTYPE html>
<html>
<head>
  <title>Edit Family Member</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="container mt-4" data-children-count="<%= children && children.length ? children.length : 0 %>">

<h3>Edit Family Member</h3>

<% if (message) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= message %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% } %>

<% if (!parent) { %>
    <div class="alert alert-danger">Parent record missing</div>
  <% } else { %>

<form method="POST" action="/admin/edit/<%= parent.family_id %>" enctype="multipart/form-data">

  <!-- Parent -->
  <h5>Parent Details</h5>
  <input class="form-control mb-2" name="name" value="<%= parent.husband_name %>" placeholder="Husband Name">
  <input class="form-control mb-2" name="wife_name" value="<%= parent.wife_name %>" placeholder="Wife Name">
  <input class="form-control mb-2" name="mobile" value="<%= parent.mobile %>" placeholder="Mobile">
  <input class="form-control mb-2" name="occupation" value="<%= parent.occupation %>" placeholder="Occupation">

  <h6>Photos</h6>
  <div class="mb-3">
    <label>Husband Photo</label>
    <input type="file" class="form-control" name="husband_photo" accept="image/*">
    <% if (parent.husband_photo) { %>
      <img src="/uploads/<%= parent.husband_photo %>" class="img-thumbnail mt-2" style="max-width: 100px;">
    <% } %>
  </div>
  <div class="mb-3">
    <label>Wife Photo</label>
    <input type="file" class="form-control" name="wife_photo" accept="image/*">
    <% if (parent.wife_photo) { %>
      <img src="/uploads/<%= parent.wife_photo %>" class="img-thumbnail mt-2" style="max-width: 100px;">
    <% } %>
  </div>

  <h6>Address</h6>
  <input class="form-control mb-2" name="door_no" value="<%= parent.door_no %>" placeholder="Door No">
  <input class="form-control mb-2" name="street" value="<%= parent.street %>" placeholder="Street">
  <input class="form-control mb-2" name="district" value="<%= parent.district %>" placeholder="District">
  <input class="form-control mb-2" name="state" value="<%= parent.state %>" placeholder="State">
  <input class="form-control mb-2" name="pincode" value="<%= parent.pincode %>" placeholder="Pincode">

  <!-- Children -->
  <h5 class="mt-4">Children</h5>
  <div id="children">
    <% children.forEach((c, i) => { %>
      <div class="border p-2 mb-2 child">
        <input type="hidden" name="children[<%= i %>][id]" value="<%= c.child_id %>">
        <input class="form-control mb-1" name="children[<%= i %>][name]" value="<%= c.child_name %>" placeholder="Child Name">
        <input class="form-control mb-1" name="children[<%= i %>][occupation]" value="<%= c.occupation %>" placeholder="Occupation">
        <input type="date" class="form-control mb-1" name="children[<%= i %>][dob]" value="<%= c.date_of_birth ? new Date(c.date_of_birth).toISOString().split('T')[0] : '' %>" placeholder="Date of Birth">
        
        <div class="mb-1">
          <label>Photo</label>
          <input type="file" class="form-control" name="children[<%= i %>][photo]" accept="image/*">
          <% if (c.photo) { %>
            <img src="/uploads/<%= c.photo %>" class="img-thumbnail mt-1" style="max-width: 100px;">
          <% } %>
        </div>
        <button type="button" class="btn btn-sm btn-danger removeChild">Remove</button>
      </div>
    <% }) %>
  </div>

  <button type="button" class="btn btn-secondary my-2" id="addChild">+ Add Child</button>

  <div class="mt-3">
    <button type="submit" class="btn btn-primary">Update Family</button>
    <a href="/admin/dashboard" class="btn btn-outline-secondary">Cancel</a>
  </div>

</form>
<% } %>

<script>
    let index =  children && children.length ? children.length : 

    $("#addChild").click(() => {
      $("#children").append(`
        <div class="border p-2 mb-2 child">
          <input class="form-control mb-1" name="children[` + index + `][name]" placeholder="Child Name">
          <input class="form-control mb-1" name="children[` + index + `][occupation]" placeholder="Occupation">
          <input type="date" class="form-control mb-1" name="children[` + index + `][dob]" placeholder="Date of Birth"
          <div class="mb-1">
            <label>Photo</label>
            <input type="file" class="form-control" name="children[` + index + `][photo]" accept="image/*">
          </div>
          <button type="button" class="btn btn-sm btn-danger removeChild">Remove</button>
        </div>
      `);
      index++;
    });

    $(document).on("click", ".removeChild", function () {
      $(this).closest(".child").remove();
    });
  </script>

</body>
</html>
